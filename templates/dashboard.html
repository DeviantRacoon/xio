{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block nav_dashboard_active %}active{% endblock %}

{% block content %}
<main class="container py-4" role="main">
  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">
        <i class="bi bi-speedometer2" aria-hidden="true"></i>
        Dashboard
      </h1>
      <p class="text-muted mb-0">Bienvenido, {{ user.first_name|default:user.username }}.</p>
    </div>

    <!-- Acciones rápidas: perfil / logout / menú -->
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'password_change' %}">
        <i class="bi bi-person-gear" aria-hidden="true"></i> Mi cuenta
      </a>
      <a class="btn btn-outline-danger" href="{% url 'logout' %}">
        <i class="bi bi-box-arrow-right" aria-hidden="true"></i> Salir
      </a>
      <a class="btn btn-primary" data-bs-toggle="offcanvas" href="#appDrawer" role="button" aria-controls="appDrawer">
        <i class="bi bi-grid" aria-hidden="true"></i> Menú
      </a>
    </div>
  </div>

  <!-- Grid principal: menú de secciones + panel lateral de usuarios -->
  <div class="row g-3">
    <!-- Menú visual de secciones -->
    <section class="col-12 col-lg-8">
      <div class="bg-white border rounded shadow-sm p-3 p-md-4">
        <h2 class="h6 text-uppercase text-muted mb-3">Secciones</h2>
        <div class="row g-3">
          <div class="col-12 col-sm-6">
            <a class="text-decoration-none" href="{% url 'user-list' %}">
              <div class="card border-0 shadow-sm h-100 hover-shadow">
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="fs-3"><i class="bi bi-people"></i></span>
                  <div>
                    <div class="fw-semibold">Usuarios</div>
                    <div class="text-muted small">Gestión de cuentas</div>
                  </div>
                </div>
              </div>
            </a>
          </div>

          <div class="col-12 col-sm-6">
            <a class="text-decoration-none" href="{% url 'role-list' %}">
              <div class="card border-0 shadow-sm h-100 hover-shadow">
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="fs-3"><i class="bi bi-shield-lock"></i></span>
                  <div>
                    <div class="fw-semibold">Roles</div>
                    <div class="text-muted small">Agrupar permisos</div>
                  </div>
                </div>
              </div>
            </a>
          </div>

          <div class="col-12 col-sm-6">
            <a class="text-decoration-none" href="{% url 'permission-list' %}">
              <div class="card border-0 shadow-sm h-100 hover-shadow">
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="fs-3"><i class="bi bi-key"></i></span>
                  <div>
                    <div class="fw-semibold">Permisos</div>
                    <div class="text-muted small">Accesos granulares</div>
                  </div>
                </div>
              </div>
            </a>
          </div>

          <div class="col-12 col-sm-6">
            <a class="text-decoration-none" href="{% url 'inventory:equipment-list' %}">
              <div class="card border-0 shadow-sm h-100 hover-shadow">
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="fs-3"><i class="bi bi-hdd-stack"></i></span>
                  <div>
                    <div class="fw-semibold">Inventario</div>
                    <div class="text-muted small">Equipos y movimientos</div>
                  </div>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Indicadores (placeholder) -->
      <div class="mt-3">
        <div class="row g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <p class="text-muted small mb-1">Usuarios activos</p>
                <p class="h4 mb-0">{{ online_users|length|default:"—" }}</p>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <p class="text-muted small mb-1">Eventos hoy</p>
                <p class="h4 mb-0">—</p>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <p class="text-muted small mb-1">Alertas</p>
                <p class="h4 mb-0">—</p>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <p class="text-muted small mb-1">Tareas</p>
                <p class="h4 mb-0">—</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Panel lateral: usuarios conectados -->
    <aside class="col-12 col-lg-4">
      <div class="bg-white border rounded shadow-sm p-3 p-md-4 h-100">
        <h2 class="h6 text-uppercase text-muted mb-3">Usuarios conectados</h2>

        {% if online_users %}
          <ul class="list-group list-group-flush">
            {% for u in online_users %}
              <li class="list-group-item d-flex align-items-center justify-content-between px-0">
                <div class="d-flex align-items-center gap-3">
                  <!-- Avatar iniciales -->
                  <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center"
                       style="width: 36px; height: 36px;">
                    <span class="small fw-semibold">{{ u.username|slice:":2"|upper }}</span>
                  </div>
                  <div>
                    <div class="fw-semibold">{{ u.get_full_name|default:u.username }}</div>
                    <div class="text-muted small">Visto {{ u.last_seen_human }}</div>
                  </div>
                </div>
                <span class="badge bg-success-subtle text-success border border-success-subtle">
                  <i class="bi bi-circle-fill small"></i> online
                </span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Nadie en línea por ahora.</div>
        {% endif %}
      </div>
    </aside>
  </div>
</main>

<!-- Offcanvas (drawer) con todas las opciones -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="appDrawer" aria-labelledby="appDrawerLabel">
  <div class="offcanvas-header">
    <h5 id="appDrawerLabel" class="mb-0"><i class="bi bi-grid me-2"></i>Menú de la app</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body">
      <div class="list-group list-group-flush">
        <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="{% url 'dashboard' %}">
          <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
        </a>
        <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="{% url 'user-list' %}">
          <i class="bi bi-people"></i> <span>Usuarios</span>
        </a>
        <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="{% url 'role-list' %}">
          <i class="bi bi-shield-lock"></i> <span>Roles</span>
        </a>
        <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="{% url 'permission-list' %}">
          <i class="bi bi-key"></i> <span>Permisos</span>
        </a>
        <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="{% url 'inventory:equipment-list' %}">
          <i class="bi bi-hdd-stack"></i> <span>Inventario</span>
        </a>
      </div>

    <hr class="my-3">

    <div class="d-grid gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'password_change' %}">
        <i class="bi bi-person-gear"></i> Mi cuenta
      </a>
      <a class="btn btn-outline-danger" href="{% url 'logout' %}">
        <i class="bi bi-box-arrow-right"></i> Cerrar sesión
      </a>
    </div>
  </div>
</div>
{% endblock %}
